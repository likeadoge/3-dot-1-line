var t=Object.defineProperty,e=(e,i,s)=>(((e,i,s)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s})(e,"symbol"!=typeof i?i+"":i,s),s);class i{constructor(t,i=t){e(this,"x",0),e(this,"y",0),this.x=t,this.y=i}trans(t,e=t){return new i(t(this.x),e(this.y))}goto(t,e){return new i(this.x+e*(t.x-this.x),this.y+e*(t.y-this.y))}add({x:t,y:e}){return new i(this.x+t,this.y+e)}}class s{constructor(){e(this,"height",2),e(this,"width",2),e(this,"bottom",-1),e(this,"top",1),e(this,"left",-1),e(this,"right",1)}centerPoint(){return new i((this.left+this.width)/2,(this.top+this.bottom)/2)}randomPoint(){return new i(this.left+Math.random()*(this.right-this.left),this.top+Math.random()*(this.bottom-this.top))}}class h extends s{constructor(t=.5){super(),e(this,"control",null),e(this,"target",null),e(this,"path",[]),e(this,"point",null),e(this,"speed");const s=Math.random()*(this.right-this.left)+this.left,h=Math.random()*(this.top-this.bottom)+this.bottom;this.speed=t,this.control=[new i(s,this.bottom),new i(s,this.top),new i(this.left,h),new i(this.right,h)][Math.floor(4*Math.random())],this.target=this.centerPoint()}createNextPath(){const t=this.target,e=this.control,s=t.x-e.x,h=s>0?this.right:this.left,n=t.y-e.y,o=n>0?this.top:this.bottom,r=new i(h,(h-t.x)/s*n+t.y),c=new i((o-t.y)/n*s+t.x,o),a=r.y>=this.bottom&&r.y<=this.top?r:c;let u=this.randomPoint();for(;u.x**2+u.y**2>1;)u=this.randomPoint();this.control=a,this.target=u,this.path=this.besier2(t,a,u).reverse()}besier2(t,e,i){const s=100/this.speed,h=[];for(let n=0;n<=s;n++){const o=n/s,r=t.goto(e,o),c=e.goto(i,o),a=r.goto(c,o);h.push(a)}return h}next(){for(;0===this.path.length;)this.createNextPath();const t=this.path.pop();if(!t)throw new Error("create next point error!");return this.point=t,t}}class n{constructor(t){e(this,"height"),e(this,"width"),e(this,"canvas",document.createElement("canvas")),e(this,"cntr"),e(this,"ctx"),this.height=t.height,this.width=t.width,this.cntr=t.cntr,this.canvas.height=this.height,this.canvas.width=this.width,console.log(this.cntr),this.cntr.appendChild(this.canvas);const i=this.canvas.getContext("2d");if(!i)throw new Error("ctx is null !!!");this.ctx=i}dot(t,e=[255,255,255,.3],i=3){const s=this.ctx;s.beginPath(),s.arc(t.x,t.y,i,0,2*Math.PI,!0),s.fillStyle=`rgba(${e.join(",")})`,s.fill()}img(t,e,s=new i(1)){this.ctx.drawImage(t.img.get(),e.x-t.width/2*s.x,e.y-t.height/2*s.y,s.x*t.width,s.y*t.height)}clear(){this.ctx.clearRect(0,0,this.width,this.height)}}class o{constructor(){e(this,"val","unfinish"),e(this,"onload",new Promise((()=>{})))}get(){if("unfinish"===this.val)throw new Error("Resource is unfinished!");return this.val}}e(o,"unfinish","unfinish!");const r=class extends class{}{constructor(t){super(),e(this,"img"),e(this,"height",0),e(this,"width",0),e(this,"onload"),this.img=t,this.img.onload.then((()=>{this.height=t.height,this.width=t.width})),this.onload=this.img.onload}draw(t,e,i=1,s=i){t.ctx.drawImage(this.img.get(),e.x-this.width/2*i,e.y-this.height/2*s,i,s)}};let c=r;e(c,"files",{target:new r(new class extends o{constructor(t){super(),e(this,"height",0),e(this,"width",0);const i=new Image;let s=t=>{},h=t=>{};this.onload=new Promise(((t,e)=>{s=t,h=e})),this.onload.then((t=>{this.val=t,this.height=t.height,this.width=t.width})),i.src=t,i.onload=()=>{s(i)},i.onerror=t=>{h(t)}}}("/img/target.png"))});class a extends s{constructor(){super(),e(this,"startMoveEvent",null),e(this,"currentMoveEvent",null),e(this,"cachePoint",new i(0,0));const t=document.querySelector("#app");if(!(t&&t instanceof HTMLElement))throw new Error;this.startMoveEvent=null,this.currentMoveEvent=null,t.addEventListener("touchstart",(t=>this.start(t))),t.addEventListener("touchmove",(t=>this.move(t))),t.addEventListener("touchend",(t=>this.over(t))),t.addEventListener("touchcancel",(t=>this.over(t)))}start(t){t.preventDefault()}move(t){t.preventDefault(),this.startMoveEvent||(this.startMoveEvent=t),this.currentMoveEvent=t}over(t){if(this.currentMoveEvent&&this.startMoveEvent){const t=new i(this.currentMoveEvent.touches[0].clientX-this.startMoveEvent.touches[0].clientX,this.currentMoveEvent.touches[0].clientY-this.startMoveEvent.touches[0].clientY);this.cachePoint=this.cachePoint.add(t)}this.startMoveEvent=null}getPoint(){if(this.currentMoveEvent&&this.startMoveEvent){const t=new i(this.currentMoveEvent.touches[0].clientX-this.startMoveEvent.touches[0].clientX,this.currentMoveEvent.touches[0].clientY-this.startMoveEvent.touches[0].clientY);return console.log(t),t.add(this.cachePoint)}return this.cachePoint}}class u{constructor(t,i,s){e(this,"above"),e(this,"start"),e(this,"end"),e(this,"up"),this.start=t,this.end=i,this.above=s?s.num(this.start):0,this.up=u.up(this.start,this.end,this.above)}static up(t,e,i){const s=8e-4*(e-t)+i;return s>=1?1:s}static down(t,e){return.001*(t-e)}num(t=(new Date).getTime()){const e=this.up-u.down(t,this.end);return e>0?e:0}}class l extends s{constructor(){super(),e(this,"currentTouchTime",0),e(this,"touchsRecords");const t=document.querySelector("#app");if(!(t&&t instanceof HTMLElement))throw new Error;t.addEventListener("touchstart",(t=>this.start(t))),t.addEventListener("touchmove",(t=>this.move(t))),t.addEventListener("touchend",(t=>this.over(t))),t.addEventListener("touchcancel",(t=>this.over(t)))}start(t){t.preventDefault(),this.currentTouchTime=(new Date).getTime()}move(t){t.preventDefault()}over(t){this.currentTouchTime&&(this.touchsRecords=new u(this.currentTouchTime,(new Date).getTime(),this.touchsRecords)),this.currentTouchTime=0}num(){const t=(new Date).getTime();if(this.currentTouchTime){console.log(1);const e=this.touchsRecords?this.touchsRecords.num(this.currentTouchTime):0;return u.up(this.currentTouchTime,t,e)}console.log(2);return this.touchsRecords?this.touchsRecords.num(t):0}}class d{constructor(t){e(this,"option"),e(this,"screen",null),e(this,"targetPosition",new h),e(this,"sightPosition",new h),e(this,"frontPosition",new h),e(this,"cameraPosition",new a),e(this,"touchTime",new l),e(this,"isRun",!1),this.option=t,this.initScreen(),this.start()}initScreen(){this.screen=new n(this.option)}draw(){if(!this.isRun)return;this.screen.clear();const t=this.targetPosition.next().trans((t=>t*this.option.width/2/10+this.option.width/2),(t=>t*this.option.height/2/10+this.option.height/2)),e=this.cameraPosition.getPoint();this.screen.img(c.files.target,t.add(e),new i(.5));const s=this.sightPosition.next().trans((t=>t*this.option.width/2/100+this.option.width/2),(t=>t*this.option.height/2/100+this.option.height/2)),h=s.add(this.frontPosition.next().trans((t=>t*this.option.width/2/100),(t=>t*this.option.height/2/100)));this.screen.dot(h,[0,255,0,1],4),this.screen.dot(s,[255,0,0,.7],4),console.log(this.touchTime.num()),requestAnimationFrame((()=>this.draw()))}async start(){await Promise.all(Array.from(Object.values(c.files)).map((t=>t.onload))),this.isRun=!0,this.draw()}stop(){this.isRun=!1}}const m=class{constructor(){if(e(this,"device",{mode:"pc",width:360,height:640}),e(this,"game",null),e(this,"element",null),m.main)return m.main;this.initDeviceInfo(),this.initElement(),this.initGame()}initDeviceInfo(){const{width:t,height:e}=document.body.getClientRects()[0],i=e>t&&t>320?"mobile":"pc";console.log(i),this.device={width:t,mode:i,height:e}}initGame(){const{width:t,height:e}="mobile"===this.device.mode?this.device:{width:360,height:640},i=this.element;this.game=new d({width:t,height:e,cntr:i})}initElement(){this.element=document.createElement("div"),this.element.id="app",this.element.dataset.mode=this.device.mode,document.body.appendChild(this.element)}onLog(t){t("game init!")}};let v=m;e(v,"main",new m),v.main.onLog((t=>console.log(t)));
